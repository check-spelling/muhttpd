#! /bin/sh

# Defaults
cgi=yes
mime=yes
handlers=yes
setuid=yes
logging=yes
pidfile=yes
background=yes
prefix='/usr/local'
packagedirsfx='/share/$(PACKAGE)-$(VERSION)'
sbindir='$(PREFIX)/sbin'
sysconfdir='$(PACKAGEDIR)/etc'
need_clearenv=yes
need_strndup=yes
need_libgen=no

# Command line options override defaults
while [ ! "$1." = '.' ]
do
	case $1 in
	--disable-cgi)
		cgi=no
	;;
	--disable-mime)
		mime=no
		handlers=no
	;;
	--disable-handlers)
		handlers=no
	;;
	--disable-setuid)
		setuid=no
	;;
	--disable-logging)
		logging=no
	;;
	--disable-pidfile)
		pidfile=no
	;;
	--disable-background)
		background=no
	;;
	--disable-everything)
		mime=no
		cgi=no
		handlers=no
		setuid=no
		logging=no
		pidfile=no
		background=no
	;;
	--enable-everything)
		mime=yes
		cgi=yes
		handlers=yes
		setuid=yes
		logging=yes
		pidfile=yes
		background=yes
	;;
	--with-libgen)
		need_libgen=yes
	;;
	--prefix)
		shift
		prefix=$1
	;;
	--packagedir)
		shift
		packagedir=$1
	;;
	--sbindir)
		shift
		sbindir=$1
	;;
	--sysconfdir)
		shift
		sysconfdir=$1
	;;
	*)
		echo 'Unknown option: ' $1
	;;
	esac
	shift
done 

# Print summary
echo "Features:"
echo "MIME Types:	$mime"
echo "CGI Support:	$cgi"
echo "Handlers:	$handlers"
echo "Set uid/gid:	$setuid"
echo "Logging:	$logging"
echo "Pidfile:	$pidfile"
echo "Backgrounding:	$background"

# Select objects to be compiled in
objects='main.o init.o socket.o request.o status.o config.o globals.o'

[ $need_strndup = 'yes' ] && objects="$objects strndup.o"
[ $need_clearenv = 'yes' ] && objects="$objects clearenv.o"
[ $mime = 'yes' ] && objects="$objects type.o"
[ $cgi = 'yes' -o $handlers = 'yes' ] && objects="$objects handler.o"
[ $logging = 'yes' ] && objects="$objects log.o"

## Generate Makefile.cfg
[ $need_libgen = 'yes' ] && LIBS="$LIBN -lgen"

cat > Makefile.cfg <<EOT
CFLAGS += $CFLAGS
LIBS += $LIBS

PREFIX = \$(DESTDIR)$prefix
PACKAGEDIR = \$(PREFIX)$packagedirsfx
TRUEPACKAGEDIR = $prefix$packagedirsfx
SBINDIR = $sbindir
SYSCONFDIR = $sysconfdir

OBJECTS = $objects
EOT

## Generate flags.h
cat > flags.h <<EOT
/* Compile time options */
EOT
[ $cgi = 'yes' ] && echo "#define ENABLE_CGI" >> flags.h
[ $handlers = 'yes' ] && echo "#define ENABLE_HANDLERS" >> flags.h
[ $mime = 'no' ] && echo "#define DISABLE_MIME" >> flags.h
[ $setuid = 'no' ] && echo "#define DISABLE_SETUID" >> flags.h
[ $logging = 'yes' ] && echo "#define ENABLE_LOGGING" >> flags.h
[ $pidfile = 'yes' ] && echo "#define ENABLE_PIDFILE" >> flags.h
[ $background = 'yes' ] && echo "#define ENABLE_BACKGROUND" >> flags.h

echo
echo 'Run make to build muhttpd'
